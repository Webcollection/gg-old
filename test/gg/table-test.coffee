require "../env"
vows = require "vows"
assert = require "assert"



suite = vows.describe "table.js"

suite.addBatch
  "nested row table":
    topic: ->
      rows = _.map _.range(100), (i) ->
        {a:i+1, b:i%10, c: i%2, id:i, nest: {d: i, e: i}, arr: [{f: 1}, {f: 2}, {f:3}] }
      t = gg.RowTable.fromArray rows
      t

    "has correct schema": (table) ->
      schema = table.schema
      _.each ['a', 'b', 'c', 'id', 'nest', 'arr'], (key) ->
        assert schema.isKey(key), "key #{key} not found"
      assert schema.isTable('arr'), "arr not a table"
      assert schema.isNested('nest'), "nest not a nested"
      _.each ['d', 'e', 'f'], (key) ->
        assert schema.isNumeric(key), "#{key} should be a number"

    "has correct keys": (table) ->
      assert.equal ("nest" in table.get(0).nestedKeys()), true
      assert.equal ("arr" in table.get(0).arrKeys()), true

    "has correct attrs": (table) ->
      attrs = table.colNames()
      row = table.get(0)
      _.each ['arr', 'a', 'b', 'c', 'id', 'd', 'e', 'f'], (attr) ->
        assert.equal (attr in attrs), true
        assert.equal row.hasAttr(attr), true

    "correct nested attrs": (table) ->
      row = table.get(0)
      attrs = row.nestedAttrs()
      _.each ['d', 'e'], (attr) ->
        assert.equal (attr in attrs), true
        assert.equal row.inNested('d'), true
        assert.equal row.inNested('e'), true

    "correct array attrs": (table) ->
      row = table.get(0)
      attrs = table.get(0).arrAttrs()
      _.each ['f'], (attr) ->
        assert.equal (attr in attrs), true
        assert.equal row.inArray('f'), true


    "flattens correctly": (table) ->
      flattened = table.flatten()
      assert.equal table.nrows() * 3, flattened.nrows()

    "when f is set":
      topic: (table) ->
        table = table.clone()
        table.each (row) -> row.set('f', [10, 11, 12])
        table

      "f is correctly set": (table) ->
        table.each (row) ->
          assert.equal row.inArray('f'), true
          assert.arrayEqual [10, 11, 12], row.get('f')

    "when scales are applied then inverted":
      topic: (table) ->
        table = table.clone()
        sf = new gg.ScaleFactory {f: {domain: [0, 100], range: [500, 600]}}
        scales = sf.scales(['f'])
        applied = scales.apply table, ['f']
        inverted = scales.invert applied, ['f']
        [scales, table, applied, inverted]

      "does not corrupt original table": ([scales, table, applied, inverted]) ->
        table.each (row) ->
          assert.arrayEqual [1,2,3], row.get('f')
        applied.each (row) ->
          assert.arrayEqual [501,502,503], row.get('f')
        inverted.each (row) ->
          assert.arrayEqual [1,2,3], row.get('f')







  "real row table":
    topic: ->
      rows = [{"pts":[{"d":1,"r":2.006012024048096,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":10,"y":10.354349725091208,"group":"1","y1":10.354349725091208,"y0":10},{"d":9,"r":2.0541082164328657,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":65.69740435799517,"y":13.189147525820871,"group":"1","y1":13.189147525820871,"y0":10},{"d":11,"r":2.0661322645290583,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":70.78420203140627,"y":13.897846976003288,"group":"1","y1":13.897846976003288,"y0":10},{"d":13,"r":2.0781563126252505,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":75.01885287188581,"y":14.606546426185705,"group":"1","y1":14.606546426185705,"y0":10},{"d":16,"r":2.096192384769539,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":80.28229921231943,"y":15.669595601459328,"group":"1","y1":15.669595601459328,"y0":10},{"d":30,"r":2.1803607214428857,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":96.21688826066855,"y":20.63049175273624,"group":"1","y1":20.63049175273624,"y0":10},{"d":41,"r":2.246492985971944,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":104.13526825853249,"y":24.52833872873953,"group":"1","y1":24.52833872873953,"y0":10},{"d":45,"r":2.270541082164329,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":106.49501563658627,"y":25.94573762910436,"group":"1","y1":25.94573762910436,"y0":10},{"d":46,"r":2.276553106212425,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":107.05215852834584,"y":26.30008735419557,"group":"1","y1":26.30008735419557,"y0":10},{"d":52,"r":2.312625250501002,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":110.16000247804553,"y":28.426185704742817,"group":"1","y1":28.426185704742817,"y0":10},{"d":54,"r":2.3246492985971945,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":111.11668134007262,"y":29.134885154925236,"group":"1","y1":29.134885154925236,"y0":10},{"d":61,"r":2.3667334669338675,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":114.20646402706737,"y":31.61533323056369,"group":"1","y1":31.61533323056369,"y0":10},{"d":66,"r":2.396793587174349,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":116.2034790134837,"y":33.38708185601973,"group":"1","y1":33.38708185601973,"y0":10},{"d":67,"r":2.402805611222445,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":116.58467388309242,"y":33.74143158111094,"group":"1","y1":33.74143158111094,"y0":10},{"d":75,"r":2.4509018036072145,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":119.44392473617978,"y":36.576229381840605,"group":"1","y1":36.576229381840605,"y0":10},{"d":76,"r":2.4569138276553106,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":119.77967773918124,"y":36.93057910693181,"group":"1","y1":36.93057910693181,"y0":10},{"d":77,"r":2.4629258517034067,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":120.11104168821382,"y":37.28492883202301,"group":"1","y1":37.28492883202301,"y0":10},{"d":80,"r":2.4809619238476954,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":121.07991049091052,"y":38.347978007296646,"group":"1","y1":38.347978007296646,"y0":10},{"d":82,"r":2.4929859719438876,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":121.70584306161236,"y":39.05667745747906,"group":"1","y1":39.05667745747906,"y0":10},{"d":84,"r":2.50501002004008,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":122.31669144196485,"y":39.76537690766148,"group":"1","y1":39.76537690766148,"y0":10},{"d":86,"r":2.5170340681362724,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":122.91316557688884,"y":40.474076357843884,"group":"1","y1":40.474076357843884,"y0":10},{"d":93,"r":2.559118236472946,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":124.89677903979242,"y":42.95452443348235,"group":"1","y1":42.95452443348235,"y0":10},{"d":102,"r":2.6132264529058116,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":127.23834858907584,"y":46.14367195930322,"group":"1","y1":46.14367195930322,"y0":10},{"d":103,"r":2.6192384769539077,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":127.48565768370564,"y":46.49802168439442,"group":"1","y1":46.49802168439442,"y0":10},{"d":112,"r":2.6733466933867733,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":129.60913886912698,"y":49.687169210215295,"group":"1","y1":49.687169210215295,"y0":10},{"d":113,"r":2.6793587174348694,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":129.83446462950764,"y":50.041518935306506,"group":"1","y1":50.041518935306506,"y0":10},{"d":121,"r":2.727454909819639,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":131.56840406281253,"y":52.87631673603617,"group":"1","y1":52.87631673603617,"y0":10},{"d":124,"r":2.7454909819639277,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":132.18922646695455,"y":53.93936591130979,"group":"1","y1":53.93936591130979,"y0":10},{"d":126,"r":2.7575150300601203,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":132.59481881788258,"y":54.64806536149221,"group":"1","y1":54.64806536149221,"y0":10},{"d":132,"r":2.7935871743486973,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":133.77405381656354,"y":56.77416371203946,"group":"1","y1":56.77416371203946,"y0":10},{"d":138,"r":2.8296593186372743,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":134.90086070734344,"y":58.90026206258671,"group":"1","y1":58.90026206258671,"y0":10},{"d":140,"r":2.841683366733467,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":135.26560054155837,"y":59.60896151276913,"group":"1","y1":59.60896151276913,"y0":10},{"d":141,"r":2.847695390781563,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":135.44602109775298,"y":59.963311237860324,"group":"1","y1":59.963311237860324,"y0":10},{"d":143,"r":2.8597194388777556,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":135.80305490329204,"y":60.67201068804275,"group":"1","y1":60.67201068804275,"y0":10},{"d":144,"r":2.8657314629258517,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":135.9797035703146,"y":61.02636041313395,"group":"1","y1":61.02636041313395,"y0":10},{"d":153,"r":2.9198396793587174,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":137.51647596499356,"y":64.21550793895483,"group":"1","y1":64.21550793895483,"y0":10},{"d":162,"r":2.973947895791583,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":138.96538351907017,"y":67.4046554647757,"group":"1","y1":67.4046554647757,"y0":10},{"d":164,"r":2.9859719438877756,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":139.2764178646922,"y":68.11335491495812,"group":"1","y1":68.11335491495812,"y0":10},{"d":169,"r":3.0160320641282565,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":140.03770574377162,"y":69.88510354041415,"group":"1","y1":69.88510354041415,"y0":10},{"d":172,"r":3.034068136272545,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":140.4837403799687,"y":70.94815271568777,"group":"1","y1":70.94815271568777,"y0":10},{"d":182,"r":3.094188376753507,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":141.9162673317732,"y":74.49164996659987,"group":"1","y1":74.49164996659987,"y0":10},{"d":184,"r":3.1062124248496996,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":142.19330813450557,"y":75.20034941678227,"group":"1","y1":75.20034941678227,"y0":10},{"d":185,"r":3.1122244488977957,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":142.33070132253067,"y":75.55469914187348,"group":"1","y1":75.55469914187348,"y0":10},{"d":186,"r":3.118236472945892,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":142.4673538428723,"y":75.9090488669647,"group":"1","y1":75.9090488669647,"y0":10},{"d":189,"r":3.13627254509018,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":142.87294619380032,"y":76.97209804223831,"group":"1","y1":76.97209804223831,"y0":10},{"d":197,"r":3.1843687374749496,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":143.9238316467092,"y":79.80689584296798,"group":"1","y1":79.80689584296798,"y0":10},{"d":200,"r":3.2024048096192383,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":144.30694696642178,"y":80.86994501824161,"group":"1","y1":80.86994501824161,"y0":10},{"d":211,"r":3.2685370741482966,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":145.6641508571788,"y":84.76779199424489,"group":"1","y1":84.76779199424489,"y0":10},{"d":213,"r":3.280561122244489,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":145.9032939622795,"y":85.47649144442731,"group":"1","y1":85.47649144442731,"y0":10},{"d":217,"r":3.3046092184368736,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":146.3749165176024,"y":86.89389034479214,"group":"1","y1":86.89389034479214,"y0":10},{"d":218,"r":3.3106212424849697,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":146.49146376260538,"y":87.24824006988334,"group":"1","y1":87.24824006988334,"y0":10},{"d":219,"r":3.3166332665330662,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":146.6074776087397,"y":87.60258979497455,"group":"1","y1":87.60258979497455,"y0":10},{"d":220,"r":3.3226452905811623,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":146.7229629161571,"y":87.95693952006576,"group":"1","y1":87.95693952006576,"y0":10},{"d":221,"r":3.3286573146292584,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":146.8379244788842,"y":88.31128924515697,"group":"1","y1":88.31128924515697,"y0":10},{"d":224,"r":3.3466933867735467,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":147.17971367220684,"y":89.37433842043059,"group":"1","y1":89.37433842043059,"y0":10},{"d":226,"r":3.3587174348697393,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":147.40503943258747,"y":90.08303787061301,"group":"1","y1":90.08303787061301,"y0":10},{"d":227,"r":3.364729458917836,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":147.51695564587652,"y":90.43738759570422,"group":"1","y1":90.43738759570422,"y0":10},{"d":231,"r":3.38877755511022,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":147.95974386721142,"y":91.85478649606905,"group":"1","y1":91.85478649606905,"y0":10},{"d":232,"r":3.3947895791583163,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":148.0692428760689,"y":92.20913622116026,"group":"1","y1":92.20913622116026,"y0":10},{"d":234,"r":3.406813627254509,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":148.28683203296083,"y":92.91783567134267,"group":"1","y1":92.91783567134267,"y0":10},{"d":235,"r":3.4128256513026054,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":148.39493019734647,"y":93.27218539643388,"group":"1","y1":93.27218539643388,"y0":10},{"d":236,"r":3.4188376753507015,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":148.50256934478975,"y":93.6265351215251,"group":"1","y1":93.6265351215251,"y0":10},{"d":240,"r":3.442885771543086,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":148.92861266990812,"y":95.04393402188992,"group":"1","y1":95.04393402188992,"y0":10},{"d":243,"r":3.460921843687375,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":149.2435108949879,"y":96.10698319716356,"group":"1","y1":96.10698319716356,"y0":10},{"d":245,"r":3.472945891783567,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":149.45129059220625,"y":96.81568264734597,"group":"1","y1":96.81568264734597,"y0":10},{"d":252,"r":3.51503006012024,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":150.16539362096242,"y":99.29613072298442,"group":"1","y1":99.29613072298442,"y0":10},{"d":257,"r":3.545090180360721,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":150.6634249869835,"y":101.06787934844046,"group":"1","y1":101.06787934844046,"y0":10},{"d":261,"r":3.5691382765531063,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":151.05492282482453,"y":102.4852782488053,"group":"1","y1":102.4852782488053,"y0":10},{"d":262,"r":3.5751503006012024,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":151.15185977329608,"y":102.8396279738965,"group":"1","y1":102.8396279738965,"y0":10},{"d":265,"r":3.5931863727454907,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":151.44046609158497,"y":103.90267714917013,"group":"1","y1":103.90267714917013,"y0":10},{"d":277,"r":3.6653306613226455,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":152.56311366147045,"y":108.15487385026464,"group":"1","y1":108.15487385026464,"y0":10},{"d":278,"r":3.6713426853707416,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":152.6544614400858,"y":108.50922357535583,"group":"1","y1":108.50922357535583,"y0":10},{"d":285,"r":3.7134268537074147,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":153.28484159061023,"y":110.98967165099428,"group":"1","y1":110.98967165099428,"y0":10},{"d":286,"r":3.7194388777555107,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":153.3736297063719,"y":111.3440213760855,"group":"1","y1":111.3440213760855,"y0":10},{"d":289,"r":3.7374749498997994,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":153.63814321399684,"y":112.40707055135911,"group":"1","y1":112.40707055135911,"y0":10},{"d":301,"r":3.809619238476954,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":154.66943043061653,"y":116.65926725245362,"group":"1","y1":116.65926725245362,"y0":10},{"d":304,"r":3.8276553106212425,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":154.92082734534097,"y":117.72231642772724,"group":"1","y1":117.72231642772724,"y0":10},{"d":307,"r":3.845691382765531,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":155.16975551071724,"y":118.78536560300087,"group":"1","y1":118.78536560300087,"y0":10},{"d":309,"r":3.8577154308617234,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":155.33435986270322,"y":119.49406505318328,"group":"1","y1":119.49406505318328,"y0":10},{"d":316,"r":3.8997995991983965,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":155.9022007842202,"y":121.97451312882174,"group":"1","y1":121.97451312882174,"y0":10},{"d":320,"r":3.9238476953907817,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":156.22106009707025,"y":123.39191202918657,"group":"1","y1":123.39191202918657,"y0":10},{"d":323,"r":3.94188376753507,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":156.45759974001996,"y":124.45496120446019,"group":"1","y1":124.45496120446019,"y0":10},{"d":325,"r":3.9539078156312626,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":156.614075429068,"y":125.16366065464261,"group":"1","y1":125.16366065464261,"y0":10},{"d":334,"r":4.008016032064128,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":157.30650339781704,"y":128.35280818046346,"group":"1","y1":128.35280818046346,"y0":10},{"d":337,"r":4.026052104208416,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":157.53317239965384,"y":129.4158573557371,"group":"1","y1":129.4158573557371,"y0":10},{"d":339,"r":4.038076152304609,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":157.6831668085052,"y":130.1245568059195,"group":"1","y1":130.1245568059195,"y0":10},{"d":350,"r":4.104208416833667,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":158.49263701706963,"y":134.0224037819228,"group":"1","y1":134.0224037819228,"y0":10},{"d":351,"r":4.110220440881763,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":158.56495940887856,"y":134.37675350701403,"group":"1","y1":134.37675350701403,"y0":10},{"d":359,"r":4.158316633266533,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":159.1362282308638,"y":137.21155130774366,"group":"1","y1":137.21155130774366,"y0":10},{"d":361,"r":4.170340681362726,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":159.27705626604308,"y":137.9202507579261,"group":"1","y1":137.9202507579261,"y0":10},{"d":370,"r":4.224448897795591,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":159.90127612561054,"y":141.10939828374697,"group":"1","y1":141.10939828374697,"y0":10},{"d":373,"r":4.24248496993988,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":160.10597964288613,"y":142.1724474590206,"group":"1","y1":142.1724474590206,"y0":10},{"d":376,"r":4.260521042084168,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":160.30904332799494,"y":143.23549663429424,"group":"1","y1":143.23549663429424,"y0":10},{"d":379,"r":4.278557114228457,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":160.51049324490947,"y":144.29854580956786,"group":"1","y1":144.29854580956786,"y0":10},{"d":381,"r":4.290581162324649,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":160.64390924306664,"y":145.00724525975028,"group":"1","y1":145.00724525975028,"y0":10},{"d":391,"r":4.350701402805611,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":161.3006553322644,"y":148.55074251066233,"group":"1","y1":148.55074251066233,"y0":10},{"d":393,"r":4.362725450901803,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":161.42998714921382,"y":149.25944196084475,"group":"1","y1":149.25944196084475,"y0":10},{"d":397,"r":4.386773547094188,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":161.68668788602952,"y":150.67684086120957,"group":"1","y1":150.67684086120957,"y0":10},{"d":399,"r":4.398797595190381,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":161.8140699688267,"y":151.385540311392,"group":"1","y1":151.385540311392,"y0":10},{"d":400,"r":4.404809619238477,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":161.87752176950164,"y":151.73989003648322,"group":"1","y1":151.73989003648322,"y0":10},{"d":401,"r":4.410821643286573,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":161.94081513854943,"y":152.0942397615744,"group":"1","y1":152.0942397615744,"y0":10},{"d":408,"r":4.452905811623246,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":162.37949819523558,"y":154.57468783721288,"group":"1","y1":154.57468783721288,"y0":10},{"d":411,"r":4.470941883767535,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":162.56520584731626,"y":155.6377370124865,"group":"1","y1":155.6377370124865,"y0":10},{"d":415,"r":4.49498997995992,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":162.81071847965595,"y":157.05513591285134,"group":"1","y1":157.05513591285134,"y0":10},{"d":423,"r":4.543086172344689,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":163.29472327675055,"y":159.889933713581,"group":"1","y1":159.889933713581,"y0":10},{"d":426,"r":4.561122244488978,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":163.47386876535936,"y":160.95298288885462,"group":"1","y1":160.95298288885462,"y0":10},{"d":430,"r":4.585170340681363,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":163.71077685547996,"y":162.37038178921946,"group":"1","y1":162.37038178921946,"y0":10},{"d":433,"r":4.603206412825651,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":163.88701613642644,"y":163.43343096449308,"group":"1","y1":163.43343096449308,"y0":10},{"d":441,"r":4.651302605210421,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":164.35108367161027,"y":166.26822876522272,"group":"1","y1":166.26822876522272,"y0":10},{"d":443,"r":4.663326653306613,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":164.46578513941557,"y":166.97692821540514,"group":"1","y1":166.97692821540514,"y0":10},{"d":450,"r":4.705410821643286,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":164.86320171825724,"y":169.4573762910436,"group":"1","y1":169.4573762910436,"y0":10},{"d":455,"r":4.735470941883767,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":165.14330380728447,"y":171.22912491649964,"group":"1","y1":171.22912491649964,"y0":10},{"d":457,"r":4.74749498997996,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":165.25448372732816,"y":171.93782436668207,"group":"1","y1":171.93782436668207,"y0":10},{"d":467,"r":4.807615230460922,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":165.80318439582828,"y":175.48132161759415,"group":"1","y1":175.48132161759415,"y0":10},{"d":474,"r":4.849699398797595,"g":1,"f":10,"t":0,"facetX":10,"facetY":1,"x":166.18032816013795,"y":177.9617696932326,"group":"1","y1":177.9617696932326,"y0":10},{"d":481,"r":4.891783567134269,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":166.5519429158254,"y":180.44221776887107,"group":"1","y1":180.44221776887107,"y0":10},{"d":486,"r":4.92184368737475,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":166.8140856980678,"y":182.21396639432712,"group":"1","y1":182.21396639432712,"y0":10},{"d":489,"r":4.939879759519037,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":166.97007992041372,"y":183.2770155696007,"group":"1","y1":183.2770155696007,"y0":10},{"d":490,"r":4.945891783567134,"g":1,"f":10,"t":1,"facetX":10,"facetY":1,"x":167.02186539528608,"y":183.63136529469193,"group":"1","y1":183.63136529469193,"y0":10},{"d":497,"r":4.987975951903808,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":167.38143144008947,"y":186.11181337033037,"group":"1","y1":186.11181337033037,"y0":10},{"d":499,"r":5,"g":1,"f":10,"t":2,"facetX":10,"facetY":1,"x":167.48323471400397,"y":186.8205128205128,"group":"1","y1":186.8205128205128,"y0":10}],"group":"1"}]
      t = gg.RowTable.fromArray rows
      t

    "flattens correctly": (table) ->
      flattened = table.flatten()
      _.each _.range(10), (idx) ->
        #console.log flattened.get(idx)
        null


  "row table":
    topic: ->
        rows = _.map _.range(100), (i) -> {a:i+1, b:i%10, c: i%2,id:i}
        t = gg.RowTable.fromArray rows
        this.callback null, t

    "is correct shape": (err, table) ->
        assert.isNull err
        assert.equal table.ncols(), 4
        assert.equal table.nrows(), 100

    "split on b":
        topic: (table) -> table.split (row) -> row.get 'b'
        "has 10 partitions": (splits) -> assert.equal _.size(splits), 10

    "transformations on b":

        "using function":
            topic: (table) -> table.transform 'b', ((v) -> -v.get('b')), no

            "is negative": (table) ->
                table.each (row) -> assert.lte row.get('b'), 0

        "using lookup":
            topic: (table) -> table.transform 'b', 'a', no
            "has same value as attr 'a'": (table) ->
                table.each (row, idx) -> assert.lte 0, row.get('b')

        "using string eval":
            topic: (table) -> table.transform 'b', '{a + 200}', no
            "b is above 200": (table) ->
                table.each (row, idx) -> assert.lte 200, row.get('b')

        "using single key object":
            topic: (table) -> table.transform {b: ((v)->-v.get('b'))}, no
            "is negative": (table) ->
                table.each (row) -> assert.lte row.get('b'), 0

        "using two key object":
            topic: (table) -> table.transform {b: ((v)->-v.get('b')), c: 'a', d: "{a+200}", a: 'a'}, no
            "is correct": (table) ->
                table.each (row) ->
                    assert.lte row.get('b'), 0
                    assert.equal row.get('a'), row.get('c')
                    assert.lt 200, row.get('d')


    "adding unequal column should fail": (table) ->
        f = () -> table.addColumn "foo", []
        assert.throws f, Error

    "can add valid column": (table) ->
        table.addColumn "d", _.range(table.nrows())
        assert.equal table.ncols(), 5

    "with function column":
        topic: ->
            v = 1
            f = () ->
                v += 2
                v
            rows = _.map _.range(100), (i) -> {a:i%10, b: f, id:i, c: [], d: { e: f}, f: [{g:f}] }
            gg.RowTable.fromArray rows
        "has correct data": (table) ->
            valid = _.range(10)
            table.each (row) ->
                assert.equal (row.get('b') % 2), 1
                assert.lt 0, row.get('b')
                assert.lt 0, row.get('e')
                _.each row.get('g'), (v) -> assert.lt 0, v
                assert.include valid, row.get('a')






suite.export module
